name: Deploy to Raspberry PI

on:
  push:
    branches:
      - feat/deploy-https

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: feat/deploy-https  

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            set -e

            APP_DIR="/home/devas/www/cards-without-humanity"
            REPO_URL="https://github.com/DevasNB/cards-without-humanity.git"
            BRANCH="feat/deploy-https"

            mkdir -p /home/devas/www

            if [ ! -d "$APP_DIR/.git" ]; then
              echo "Repository not found, cloning..."
              rm -rf "$APP_DIR"
              git clone -b $BRANCH $REPO_URL "$APP_DIR"
            else
              echo "Repository found, updating..."
              cd "$APP_DIR"
              git fetch origin
              git checkout $BRANCH
              git pull origin $BRANCH
            fi

            cd "$APP_DIR"

            echo "Stopping all running containers..."
            docker stop $(docker ps -q) || true

            echo "Cleaning old containers..."
            docker rm $(docker ps -aq) || true

            echo "Removing old images, freeing ports..."
            docker system prune -af || true

            echo "Starting reverse proxy and SSL services first..."
            docker compose up -d nginx-proxy letsencrypt || exit 1

            echo "Waiting for proxy to initialize..."
            sleep 10

            echo "Starting remaining services..."
            docker compose up -d --build || exit 1
