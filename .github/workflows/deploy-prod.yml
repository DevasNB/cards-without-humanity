name: Deploy to Raspberry PI

on:
  push:
    branches:
      - feat/deploy-https

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: feat/deploy-https  

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            set -e

            APP_DIR="/home/devas/www/cards-without-humanity"
            REPO_URL="https://github.com/DevasNB/cards-without-humanity.git"
            BRANCH="feat/deploy-https"

            mkdir -p /home/devas/www

            if [ ! -d "$APP_DIR/.git" ]; then
              echo "Repository not found, cloning..."
              rm -rf "$APP_DIR"
              git clone -b $BRANCH $REPO_URL "$APP_DIR"
            else
              echo "Repository found, updating..."
              cd "$APP_DIR"
              git fetch origin
              git checkout $BRANCH
              git pull origin $BRANCH
            fi

            cd "$APP_DIR"

            echo "Stopping old containers..."
            docker compose down

            # Cria volumes se não existirem
            mkdir -p ./data/certbot/www ./data/certbot/conf ./nginx/ssl-enabled

            # Garante que os ficheiros necessários do Certbot existem
            if [ ! -f ./data/certbot/conf/options-ssl-nginx.conf ]; then
              echo "⚙️ Criando options-ssl-nginx.conf padrão..."
              cat > ./data/certbot/conf/options-ssl-nginx.conf <<'EOF'
            ssl_session_cache shared:le_nginx_SSL:10m;
            ssl_session_timeout 1440m;
            ssl_protocols TLSv1.2 TLSv1.3;
            ssl_prefer_server_ciphers off;
            EOF
            fi

            if [ ! -f ./data/certbot/conf/ssl-dhparams.pem ]; then
              echo "⚙️ Criando ssl-dhparams.pem..."
              openssl dhparam -out ./data/certbot/conf/ssl-dhparams.pem 2048
            fi

            # Start nginx apenas com HTTP para servir desafios ACME
            docker compose up -d --build nginx
            sleep 5

            # Roda certbot em staging (não conta para rate limit)
            docker compose run --rm certbot certonly \
              --staging \
              --webroot -w /var/www/certbot \
              -d cards.devas.pt -d cardsapi.devas.pt \
              --email joaodevesa212@gmail.com \
              --agree-tos \
              --non-interactive \
              --keep-until-expiring || echo "⚠️ Falhou emissão staging, mantendo certificados antigos."

            # Copia ficheiros HTTPS apenas se os certificados staging foram criados
            if [ -f ./data/certbot/conf/live/cards.devas.pt/fullchain.pem ]; then
                cp ./nginx/ssl-cards.conf ./nginx/ssl-enabled/
            fi
            if [ -f ./data/certbot/conf/live/cardsapi.devas.pt/fullchain.pem ]; then
                cp ./nginx/ssl-cardsapi.conf ./nginx/ssl-enabled/
            fi

            # Reinicia nginx para carregar os certificados HTTPS (mesmo staging)
            docker compose restart nginx

            # Start do container certbot para renovações automáticas
            docker compose up -d certbot
